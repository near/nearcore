stages:
    - test

variables:
    CACHE_ROOT: "/opt/nearcore"

.setup_cache: &setup_cache
    mkdir -p "${CACHE_ROOT}/target" &&
    ln -s "${CACHE_ROOT}/target" "${CI_PROJECT_DIR}/target"

# Test all but expensive integration tests.
test_cargo:
    stage: test
    tags:
    - shell
    before_script:
    - *setup_cache
    script:
    - rustc --version && cargo --version
    - cargo check --all --tests --benches --all-features
    - cargo test --all --verbose

# Regression tests.
test_regression:
    stage: test
    before_script:
    - *setup_cache
    script:
    - rustc --version && cargo --version
    - ./scripts/build_wasm.sh
    - cargo test --package nearcore --test test_tps_regression test --features "regression_tests,fake_crypto"
    tags:
    - shell
    - regression_tests
    only:
    - schedules

# A set of expensive tests.
test_cases_testnet_rpc:
    stage: test
    before_script:
    - *setup_cache
    script:
    - rustc --version && cargo --version
    - ./scripts/build_wasm.sh
    - cargo test --package nearcore --test test_cases_testnet_rpc test --features "expensive_tests"
    tags:
    - shell
    - expensive_tests
    only:
    - schedules

test_nearlib:
    stage: test
    tags:
    - shell
    before_script:
    - *setup_cache
    script:
    - ./scripts/test_nearlib.sh
