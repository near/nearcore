server {
    listen 80;
    root /var/www/html;
    
    # 1. Resolver is required when using variables in proxy_pass.
    # 8.8.8.8 is Google DNS; suitable for Cloud Run to resolve external domains.
    resolver 8.8.8.8; 

    location /static {
        alias /var/www/html/static;
    }

    # 2. The Proxy Block
    # Pattern matches: /api-proxy/TARGET_ADDRESS/REAL_API_PATH
    location ~ ^/api-proxy/([^/]+)/(.*)$ {
        # Capture the target address ($1) and the rest of the path ($2)
        set $target_host $1;
        set $api_path $2;

        # Proxy configuration
        proxy_pass http://$target_host/$api_path$is_args$args;
        
        # Standard proxy headers
        proxy_set_header Host $target_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # IMPORTANT: Hide the fact that this is a proxy from the browser
        # to avoid CORS issues (optional, depending on your API)
        add_header 'Access-Control-Allow-Origin' '*';
    }

    location / {
        try_files $uri /index.html;
    }
}