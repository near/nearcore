<html>
<head>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        td {
            text-align: left;
            vertical-align: top;
            padding: 8px;
        }

        th {
            text-align: center;
            vertical-align: center;
            padding: 8px;
            background-color: lightgrey;
        }

        tr.active {
            background-color: #eff8bf;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        function printTimeInMs(time) {
            if (time == null) {
                return "N/A"
            } else {
                return time + "ms"
            }
        }

        function prettyTime(dtString) {
            let time = new Date(Date.parse(dtString));
            return time.getUTCHours() + ":" + String(time.getUTCMinutes()).padStart(2, "0") + ":" +
                String(time.getUTCSeconds()).padStart(2, "0") + "." + String(time.getUTCMilliseconds()).padStart(3, '0')
        }

        function generateBlocksTableHeader(num_shards) {
            let row = $('<tr>');
            row.append("<th>Height</th>");
            row.append("<th>Hash</th>");
            row.append("<th>Status</th>");
            row.append("<th>In Progress for</th>");
            row.append("<th>In Orphan for</th>");
            row.append("<th>Missing Chunks for</th>");
            row.append("<th>Chunk status</th>");
            for (i = 0; i < num_shards; i+=1) {
                row.append("<th>Shard " + i + "</th>");
            }
            $('.js-blocks-thead').append(row);
        }

        function printChunkInfoSummary(chunks_info) {
            let chunk_status = [];
            chunks_info.forEach(chunk => {
                if (chunk == null) {
                    chunk_status.push("X");
                } else {
                    switch (chunk.status) {
                        case "Completed":
                            chunk_status.push("✔");
                            break;
                        case "Requested":
                            chunk_status.push("⬇");
                            break;
                        case "NeedToRequest":
                            chunk_status.push(".");
                            break;
                        default:
                            break;
                    }
                }
            });
            return chunk_status.join("")
        }

        function printChunksInfo(chunks_info, row) {
            chunks_info.forEach(chunk => {
                let cell = $('<td>');
                if (chunk == null) {
                    cell.append("No Chunk")
                } else {
                    cell.append(chunk.status);
                    if (chunk.requested_timestamp != null) {
                        cell.append("<br>Requested: " + prettyTime(chunk.requested_timestamp));
                    }
                    if (chunk.request_duration != null) {
                        cell.append("<br>Chunk completed in " + chunk.request_duration + "ms");
                    }
                }
                row.append(cell);
            })
        }

        $(document).ready(() => {
            $('span').text("Loading...");
            $.ajax({
                type: "GET",
                url: "/debug/api/status",
                success: data => {
                    let head = data.detailed_debug_status.current_head_status;
                    let header_head = data.detailed_debug_status.current_header_head_status;
                    $('.js-chain-info-summary-head').append("Current head: " + head.hash + "@" + head.height + "\n");
                    $('.js-chain-info-summary-header-head').append("Current header head: " + header_head.hash + "@" + header_head.height + "\n");
                    let chain_info = data.detailed_debug_status.chain_processing_info;
                    $('.js-chain-info-summary-orphans').append("Num blocks in orphan pool: " + chain_info.num_orphans + "\n");
                    $('.js-chain-info-summary-missing-chunks').append("Num blocks in missing chunks pool: " + chain_info.num_blocks_missing_chunks + "\n");
                    $('.js-chain-info-summary-processing').append("Num blocks in processing: " + chain_info.num_blocks_in_processing + "\n");

                    let num_shards = 0;
                    chain_info.blocks_info.forEach(block => {
                        if (block.hash == head.hash) {
                            $('.js-blocks-tbody').append($("<tr><td colspan=10><b>HEAD</b></td></tr>"));
                        }
                        num_shards = block.chunks_info.length;
                        let row = $('<tr>');
                        row.append($('<td>').append(block.height));
                        row.append($('<td>').append(block.hash));
                        row.append($('<td>').append(block.block_status));
                        row.append($('<td>').append(printTimeInMs(block.in_progress_ms)));
                        row.append($('<td>').append(printTimeInMs(block.orphaned_ms)));
                        row.append($('<td>').append(printTimeInMs(block.missing_chunks_ms)));
                        row.append($('<td>').append(printChunkInfoSummary(block.chunks_info)));
                        printChunksInfo(block.chunks_info, row);
                        $('.js-blocks-tbody').append(row)

                    })

                    chain_info.floating_chunks_info.forEach(chunk=> {
                        let row = $('<tr>');
                        row.append($('<td>').append(chunk.height_created));
                        row.append($('<td>').append(chunk.shard_id));
                        row.append($('<td>').append(chunk.chunk_hash));
                        row.append($('<td>').append(chunk.created_by));
                        row.append($('<td>').append(chunk.status));

                    })

                    generateBlocksTableHeader(num_shards);
                },
                dataType: "json",
                error: function (errMsg, textStatus, errorThrown) {
                    alert("Failed: " + textStatus + " :" + errorThrown);
                },
                contentType: "application/json; charset=utf-8",
            })

        });
    </script>
</head>
<body>
    <h1>
        Welcome to the Chain & Chunk Status page!
    </h1>
    <h2> Chain Info Summary </h2>
    <h3 class="js-chain-info-summary-head"></h3>
    <h3 class="js-chain-info-summary-header-head"></h3>
    <h3 class="js-chain-info-summary-orphans"></h3>
    <h3 class="js-chain-info-summary-missing-chunks"></h3>
    <h3 class="js-chain-info-summary-processing"></h3>

    <h3>Floating chunks</h3>
    <div>Floating chunks are the chunks for which we don't know the block they belong to yet.</div>
    <table>
        <thead>
        <tr>
            <th>Height</th>
            <th>ShardId</th>
            <th>Hash</th>
            <th>Created by</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody class="js-floating-chunks-tbody">
        </tbody>
    </table>

    <h3>Blocks</h3>
    <table>
        <thead class="js-blocks-thead">
        </thead>
        <tbody class="js-blocks-tbody">
        </tbody>
    </table>
</body>

</html>
