<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Overview - Guide to Nearcore Development</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture</li><li class="chapter-item expanded "><a href="../architecture/index.html" class="active"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../architecture/how/index.html"><strong aria-hidden="true">2.</strong> How neard works</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/how/sync.html"><strong aria-hidden="true">2.1.</strong> How Sync Works</a></li><li class="chapter-item expanded "><a href="../architecture/how/gc.html"><strong aria-hidden="true">2.2.</strong> Garbage Collection</a></li><li class="chapter-item expanded "><a href="../architecture/how/epoch.html"><strong aria-hidden="true">2.3.</strong> How Epoch Works</a></li><li class="chapter-item expanded "><a href="../architecture/how/tx_routing.html"><strong aria-hidden="true">2.4.</strong> Transaction Routing</a></li><li class="chapter-item expanded "><a href="../architecture/how/tx_receipts.html"><strong aria-hidden="true">2.5.</strong> Transactions And Receipts</a></li><li class="chapter-item expanded "><a href="../architecture/how/cross-shard.html"><strong aria-hidden="true">2.6.</strong> Cross shard transactions - deep dive</a></li><li class="chapter-item expanded "><a href="../architecture/how/gas.html"><strong aria-hidden="true">2.7.</strong> Gas</a></li><li class="chapter-item expanded "><a href="../architecture/how/meta-tx.html"><strong aria-hidden="true">2.8.</strong> Meta transactions</a></li><li class="chapter-item expanded "><a href="../architecture/how/serialization.html"><strong aria-hidden="true">2.9.</strong> Serialization: Borsh, Json, ProtoBuf</a></li><li class="chapter-item expanded "><a href="../architecture/how/proofs.html"><strong aria-hidden="true">2.10.</strong> Proofs</a></li><li class="chapter-item expanded "><a href="../architecture/how/resharding.html"><strong aria-hidden="true">2.11.</strong> Resharding</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/next/index.html"><strong aria-hidden="true">3.</strong> How neard will work</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/next/catchup_and_state_sync.html"><strong aria-hidden="true">3.1.</strong> Catchup and state sync improvements</a></li><li class="chapter-item expanded "><a href="../architecture/next/malicious_chunk_producer_and_phase2.html"><strong aria-hidden="true">3.2.</strong> Malicious producers and phase 2</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/storage.html"><strong aria-hidden="true">4.</strong> Storage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/storage/flow.html"><strong aria-hidden="true">4.1.</strong> Storage Request Flow</a></li><li class="chapter-item expanded "><a href="../architecture/storage/trie.html"><strong aria-hidden="true">4.2.</strong> Trie</a></li><li class="chapter-item expanded "><a href="../architecture/storage/database.html"><strong aria-hidden="true">4.3.</strong> Database Format</a></li><li class="chapter-item expanded "><a href="../architecture/storage/flat_storage.html"><strong aria-hidden="true">4.4.</strong> Flat Storage</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/network.html"><strong aria-hidden="true">5.</strong> Network</a></li><li class="chapter-item expanded "><a href="../architecture/gas/index.html"><strong aria-hidden="true">6.</strong> Gas Cost Parameters</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/gas/parameter_definition.html"><strong aria-hidden="true">6.1.</strong> Parameter Definitions</a></li><li class="chapter-item expanded "><a href="../architecture/gas/gas_profile.html"><strong aria-hidden="true">6.2.</strong> Gas Profile</a></li><li class="chapter-item expanded "><a href="../architecture/gas/estimator.html"><strong aria-hidden="true">6.3.</strong> Runtime Parameter Estimator</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Practices</li><li class="chapter-item expanded "><a href="../practices/index.html"><strong aria-hidden="true">7.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../practices/rust.html"><strong aria-hidden="true">8.</strong> Rust ðŸ¦€</a></li><li class="chapter-item expanded "><a href="../practices/workflows/index.html"><strong aria-hidden="true">9.</strong> Workflows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../practices/workflows/run_a_node.html"><strong aria-hidden="true">9.1.</strong> Run a Node</a></li><li class="chapter-item expanded "><a href="../practices/workflows/deploy_a_contract.html"><strong aria-hidden="true">9.2.</strong> Deploy a Contract</a></li><li class="chapter-item expanded "><a href="../practices/workflows/gas_estimations.html"><strong aria-hidden="true">9.3.</strong> Run Gas Estimations</a></li><li class="chapter-item expanded "><a href="../practices/workflows/localnet_on_many_machines.html"><strong aria-hidden="true">9.4.</strong> Localnet on many machines</a></li><li class="chapter-item expanded "><a href="../practices/workflows/io_trace.html"><strong aria-hidden="true">9.5.</strong> IO tracing</a></li></ol></li><li class="chapter-item expanded "><a href="../practices/style.html"><strong aria-hidden="true">10.</strong> Code Style</a></li><li class="chapter-item expanded "><a href="../practices/docs.html"><strong aria-hidden="true">11.</strong> Documentation</a></li><li class="chapter-item expanded "><a href="../practices/tracking_issues.html"><strong aria-hidden="true">12.</strong> Tracking Issues</a></li><li class="chapter-item expanded "><a href="../practices/security_vulnerabilities.html"><strong aria-hidden="true">13.</strong> Security Vulnerabilities</a></li><li class="chapter-item expanded "><a href="../practices/fast_builds.html"><strong aria-hidden="true">14.</strong> Fast Builds</a></li><li class="chapter-item expanded "><a href="../practices/testing/index.html"><strong aria-hidden="true">15.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../practices/testing/python_tests.html"><strong aria-hidden="true">15.1.</strong> Python Tests</a></li><li class="chapter-item expanded "><a href="../practices/testing/test_utils.html"><strong aria-hidden="true">15.2.</strong> Testing Utils</a></li></ol></li><li class="chapter-item expanded "><a href="../practices/protocol_upgrade.html"><strong aria-hidden="true">16.</strong> Protocol Upgrade</a></li><li class="chapter-item expanded affix "><li class="part-title">Advanced configuration</li><li class="chapter-item expanded "><a href="../advanced_configuration/networking.html"><strong aria-hidden="true">17.</strong> Networking</a></li><li class="chapter-item expanded affix "><li class="part-title">Custom test networks</li><li class="chapter-item expanded "><a href="../test_networks/mainnet_spoon.html"><strong aria-hidden="true">18.</strong> Starting a network from mainnet state</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="../misc/index.html"><strong aria-hidden="true">19.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../misc/state_sync_dump.html"><strong aria-hidden="true">20.</strong> State Sync Dump</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Guide to Nearcore Development</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/near/nearcore/tree/master/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/near/nearcore/edit/master/docs/./architecture/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>This document describes the high-level architecture of nearcore. The focus here
is on the implementation of the blockchain protocol, not the protocol itself.
For reference documentation of the protocol, please refer to
<a href="https://nomicon.io/">nomicon</a></p>
<p>Some parts of our architecture are also covered in this <a href="https://www.youtube.com/playlist?list=PL9tzQn_TEuFV4qlts0tVgndnytFs4QSYo">video series on YouTube</a>.</p>
<h2 id="birds-eye-view"><a class="header" href="#birds-eye-view">Bird's Eye View</a></h2>
<p>If we put the entirety of nearcore onto one picture, we get something like this:</p>
<p><img src="../images/architecture.svg" alt="" /></p>
<p>Don't worry if this doesn't yet make a lot of sense: hopefully, by the end of
this document the above picture would become much clearer!</p>
<h2 id="overall-operation"><a class="header" href="#overall-operation">Overall Operation</a></h2>
<p><code>nearcore</code> is a blockchain node -- it's a single binary (<code>neard</code>) which runs on
some machine and talks to other similar binaries running elsewhere. Together,
the nodes agree (using a distributed consensus algorithm) on a particular
sequence of transactions. Once transaction sequence is established, each node
applies transactions to the current state. Because transactions are fully
deterministic, each node in the network ends up with identical state. To allow
greater scalability, NEAR protocol uses sharding, which allows a node to hold
only a small subset (shard) of the whole state.</p>
<p><code>neard</code> is a stateful, restartable process. When <code>neard</code> starts, the node
connects to the network and starts processing blocks (block is a batch of
transactions, processed together; transactions are batched into blocks for
greater efficiency). The results of processing are persisted in the database.
RocksDB is used for storage. Usually, the node's data is found in the <code>~/.near</code>
directory. The node can be stopped at any moment and be restarted later. While
the node is offline it misses the block, so, after a restart, the sync process
kicks in which brings the node up-to-speed with the network by downloading the
missing bits of history from more up-to-date peer nodes.</p>
<p>Major components of nearcore:</p>
<ul>
<li>
<p><strong>JSON RPC</strong>. This HTTP RPC interface is how <code>neard</code> communicates with
non-blockchain outside world. For example, to submit a transaction, some
client sends an RPC request with it to some node in the network. From that
node, the transaction propagates through the network, until it is included in
some block. Similarly, a client can send an HTTP request to a node to learn
about current state of the blockchain. The <strong>JSON RPC</strong> interface is documented
<a href="https://docs.near.org/api/rpc/introduction">here</a>.</p>
</li>
<li>
<p><strong>Network</strong>. If RPC is aimed &quot;outside&quot; the blockchain, &quot;network&quot; is how peer
<code>neard</code> nodes communicate with each other within the blockchain. RPC carries
requests from users of the blockchain, while network carries various messages
needed to implement consensus. Two directly connected nodes communicate by
sending protobuf-encoded messages over TCP. A node also includes logic to
route messages for indirect peers through intermediaries. Oversimplifying a
lot, it's enough for a new node to know an IP address of just one other
network participant. From this bootstrap connection, the node learns how to
communicate with any other node in the network.</p>
</li>
<li>
<p><strong>Client</strong>. Somewhat confusingly named, <strong>client</strong> is the logical state of the
blockchain. After receiving and decoding a request, both <strong>RPC</strong> and <strong>network</strong>
usually forward it in the parsed form to the <strong>client</strong>. Internally, <strong>client</strong> is
split in two somewhat independent components: <strong>chain</strong> and <strong>runtime</strong>.</p>
</li>
<li>
<p><strong>Chain</strong>. The job of <strong>chain</strong>, in a nutshell, is to determine a global order of
transactions. <strong>Chain</strong> builds and maintains the blockchain data structure. This
includes block and chunk production and processing, consensus, and validator
selection. However, <strong>chain</strong> is not responsible for actually applying
transactions and receipts.</p>
</li>
<li>
<p><strong>Runtime</strong>. If <strong>chain</strong> selects the <em>order</em> of transactions, <strong>Runtime</strong> applies
transaction to the state. <strong>Chain</strong> guarantees that everyone agrees on the order
and content of transactions, and <strong>Runtime</strong> guarantees that each transaction is
fully deterministic. It follows that everyone agrees on the &quot;current state&quot; of
the blockchain. Some transactions are as simple as &quot;transfer X tokens from
Alice to Bob&quot;. But a much more powerful class of transactions is supported:
&quot;run this arbitrary WebAssembly code in the context of the current state of
the chain&quot;. Running such &quot;smart contract&quot; transactions securely and
efficiently is a major part of what <strong>Runtime</strong> does. Today, <strong>Runtime</strong> uses a JIT
compiler to do that.</p>
</li>
<li>
<p><strong>Storage</strong>. <strong>Storage</strong> is more of a cross-cutting concern, than an isolated
component. Many parts of a node want to durably persist various bits of state
to disk. One notable case is the logical state of the blockchain, and, in
particular, data associated with each account. Logically, the state of an account
on a chain is a key-value map: <code>HashMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;</code>. But there is a
twist: it should be possible to provide a succinct proof that a particular key
indeed holds a particular value. To allow that internally the state is
implemented as a persistent (in both senses, &quot;functional&quot; and &quot;on disk&quot;)
merkle-patricia trie.</p>
</li>
<li>
<p><strong>Parameter Estimator</strong>. One kind of transaction we support is &quot;run this
arbitrary, Turing-complete computation&quot;. To protect from a <code>loop {}</code>
transaction halting the whole network, <strong>Runtime</strong> implements resource limiting:
each transaction runs with a certain finite amount of &quot;gas&quot;, and each
operation costs a certain amount of gas to perform. <strong>Parameter estimator</strong> is
essentially a set of benchmarks used to estimate relative gas costs of
various operations.</p>
</li>
</ul>
<h2 id="entry-points"><a class="header" href="#entry-points">Entry Points</a></h2>
<p><code>neard/src/main.rs</code> contains the main function that starts a blockchain node.
However, this file mostly only contains the logic to parse arguments and
dispatch different commands. <code>start_with_config</code> in <code>nearcore/src/lib.rs</code> is the
actual entry point and it starts all the actors.</p>
<p><code>JsonRpcHandler::process</code> in the <code>jsonrpc</code> crate is the RPC entry point. It
implements the public API of a node, which is documented
<a href="https://docs.near.org/api/rpc/introduction">here</a>.</p>
<p><code>PeerManagerActor::spawn</code> in the <code>network</code> is an entry for the other point of
contract with the outside world -- the peer-to-peer network.</p>
<p><code>Runtime::apply</code> in the <code>runtime</code> crate is the entry point for transaction
processing logic. This is where state transitions actually happen, after chain
decided, according to distributed consensus, which transitions need  to
happen.</p>
<h2 id="code-map"><a class="header" href="#code-map">Code Map</a></h2>
<p>This section contains some high-level overview of important crates and data
structures.</p>
<h3 id="coreprimitives"><a class="header" href="#coreprimitives"><code>core/primitives</code></a></h3>
<p>This crate contains most of the types that are shared across different crates.</p>
<h3 id="coreprimitives-core"><a class="header" href="#coreprimitives-core"><code>core/primitives-core</code></a></h3>
<p>This crate contains types needed for runtime.</p>
<h3 id="corestoretrie"><a class="header" href="#corestoretrie"><code>core/store/trie</code></a></h3>
<p>This directory contains the MPT state implementation. Note that we usually use
<code>TrieUpdate</code> to interact with the state.</p>
<h3 id="chainchain"><a class="header" href="#chainchain"><code>chain/chain</code></a></h3>
<p>This crate contains most of the chain logic (consensus, block processing, etc).
<code>ChainUpdate::process_block</code> is where most of the block processing logic
happens.</p>
<p><strong>State update</strong></p>
<p>The blockchain state of a node can be changed in the following two ways:</p>
<ul>
<li>Applying a chunk. This is how the state is normally updated: through
<code>Runtime::apply</code>.</li>
<li>State sync. State sync can happen in two cases:
<ul>
<li>A node is far enough behind the most recent block and triggers state sync to
fast forward to the state of a very recent block without having to apply
blocks in the middle.</li>
<li>A node is about to become validator for some shard in the next epoch, but it
does not yet have the state for that shard. In this case, it would run state
sync through the <code>catchup</code> routine.</li>
</ul>
</li>
</ul>
<h3 id="chainchunks"><a class="header" href="#chainchunks"><code>chain/chunks</code></a></h3>
<p>This crate contains most of the sharding logic which includes chunk creation,
distribution, and processing. <code>ShardsManager</code> is the main struct that
orchestrates everything here.</p>
<h3 id="chainclient"><a class="header" href="#chainclient"><code>chain/client</code></a></h3>
<p>This crate defines two important structs, <code>Client</code> and <code>ViewClient</code>. <code>Client</code>
includes everything necessary for the chain (without network and runtime) to
function and runs in a single thread. <code>ViewClient</code> is a &quot;read-only&quot; client that
answers queries without interfering with the operations of <code>Client</code>.
<code>ViewClient</code> runs in multiple threads.</p>
<h3 id="chainnetwork"><a class="header" href="#chainnetwork"><code>chain/network</code></a></h3>
<p>This crate contains the entire implementation of the p2p network used by NEAR
blockchain nodes.</p>
<p>Two important structs here: <code>PeerManagerActor</code> and <code>Peer</code>. Peer manager
orchestrates all the communications from network to other components and from
other components to network. <code>Peer</code> is responsible for low-level network
communications from and to a given peer (more details in
<a href="./network.html#23-peeractor">this article</a>). Peer manager runs in one thread while each
<code>Peer</code> runs in its own thread.</p>
<p><strong>Architecture Invariant:</strong> Network communicates to <code>Client</code> through
<code>NetworkClientMessages</code> and to <code>ViewClient</code> through <code>NetworkViewClientMessages</code>.
Conversely, <code>Client</code> and <code>ViewClient</code> communicates to network through
<code>NetworkRequests</code>.</p>
<h3 id="chainepoch_manager"><a class="header" href="#chainepoch_manager"><code>chain/epoch_manager</code></a></h3>
<p>This crate is responsible for determining validators and other epoch related
information such as epoch id for each epoch.</p>
<p><strong>Note:</strong> <code>EpochManager</code> is constructed in <code>NightshadeRuntime</code> rather than in
<code>Chain</code>, partially because we had this idea of making epoch manager a smart
contract.</p>
<h3 id="chainjsonrpc"><a class="header" href="#chainjsonrpc"><code>chain/jsonrpc</code></a></h3>
<p>This crate implements <a href="https://www.jsonrpc.org/">JSON-RPC</a> API server to enable
submission of new transactions and inspection of the blockchain data, the
network state, and the node status. When a request is processed, it generates a
message to either <code>ClientActor</code> or <code>ViewClientActor</code> to interact with the
blockchain. For queries of blockchain data, such as block, chunk, account, etc,
the request usually generates a message to <code>ViewClientActor</code>. Transactions, on
the other hand, are sent to <code>ClientActor</code> for further processing.</p>
<h3 id="runtimeruntime"><a class="header" href="#runtimeruntime"><code>runtime/runtime</code></a></h3>
<p>This crate contains the main entry point to runtime -- <code>Runtime::apply</code>. This
function takes <code>ApplyState</code>, which contains necessary information passed from
chain to runtime, a list of <code>SignedTransaction</code> and a list of <code>Receipt</code>, and
returns a <code>ApplyResult</code>, which includes state changes, execution outcomes, etc.</p>
<p><strong>Architecture Invariant:</strong> The state update is only finalized at the end of
<code>apply</code>. During all intermediate steps state changes can be reverted.</p>
<h3 id="runtimenear-vm-logic"><a class="header" href="#runtimenear-vm-logic"><code>runtime/near-vm-logic</code></a></h3>
<p><code>VMLogic</code> contains all the implementations of host functions and is the
interface between runtime and wasm. <code>VMLogic</code> is constructed when runtime
applies function call actions. In <code>VMLogic</code>, interaction with NEAR blockchain
happens in the following two ways:</p>
<ul>
<li><code>VMContext</code>, which contains lightweight information such as current block
hash, current block height, epoch id, etc.</li>
<li><code>External</code>, which is a trait that contains functions to interact with
blockchain by either reading some nontrivial data, or writing to the
blockchain.</li>
</ul>
<h3 id="runtimenear-vm-runner"><a class="header" href="#runtimenear-vm-runner"><code>runtime/near-vm-runner</code></a></h3>
<p><code>run</code> function in <code>runner.rs</code> is the entry point to the vm runner. This function
essentially spins up the vm and executes some function in a contract. It
supports different wasm compilers including wasmer0, wasmer2, and wasmtime
through compile-time feature flags. Currently we use wasmer0 and wasmer2 in
production. The <code>imports</code> module exposes host functions defined in
<code>near-vm-logic</code> to WASM code. In other words, it defines the ABI of the
contracts on NEAR.</p>
<h3 id="neard"><a class="header" href="#neard"><code>neard</code></a></h3>
<p>As mentioned before, <code>neard</code> is the crate that contains that main entry points.
All the actors are spawned in <code>start_with_config</code>. It is also worth noting that
<code>NightshadeRuntime</code> is the struct that implements <code>RuntimeAdapter</code>.</p>
<!-- TODO: Maybe add RuntimeAdapter mention or explanation in runtime/runtime chapter? -->
<h3 id="corestoresrcdbrs"><a class="header" href="#corestoresrcdbrs"><code>core/store/src/db.rs</code></a></h3>
<p>This file contains the schema (DBCol) of our internal RocksDB storage - a good
starting point when reading the code base.</p>
<h2 id="cross-cutting-concerns"><a class="header" href="#cross-cutting-concerns">Cross Cutting Concerns</a></h2>
<h3 id="observability"><a class="header" href="#observability">Observability</a></h3>
<p>The <a href="https://tracing.rs">tracing</a> crate is used for structured, hierarchical
event output and logging. We also integrate <a href="https://prometheus.io">Prometheus</a>
for light-weight metric output. See the <a href="../practices/style.html">style</a> documentation for
more information on the usage.</p>
<h3 id="testing"><a class="header" href="#testing">Testing</a></h3>
<p>Rust has built-in support for writing unit tests by marking functions
with the <code>#[test]</code> directive.  Take full advantage of that!  Testing not
only confirms that what was written works the way it was intended to but
also helps during refactoring since it catches unintended behaviour
changes.</p>
<p>Not all tests are created equal though and while some may only need
milliseconds to run, others may run for several seconds or even
minutes.  Tests that take a long time should be marked as such with an
<code>expensive_tests</code> feature, for example:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[test]
#[cfg_attr(not(feature = &quot;expensive_tests&quot;), ignore)]
fn test_catchup_random_single_part_sync() {
    test_catchup_random_single_part_sync_common(false, false, 13)
}
<span class="boring">}
</span></code></pre></pre>
<p>Such tests will be ignored by default and can be executed by using
<code>--ignored</code> or <code>--include-ignored</code> flag as in <code>cargo test -- --ignored</code> or by compiling the tests with <code>expensive_tests</code> feature
enabled.</p>
<p>Because expensive tests are not run by default, they are also not run
in CI.  Instead, they are run nightly and need to be explicitly
included in <code>nightly/expensive.txt</code> file; for example:</p>
<pre><code class="language-text">expensive --timeout=1800 near-client near_client tests::catching_up::test_catchup_random_single_part_sync
expensive --timeout=1800 near-client near_client tests::catching_up::test_catchup_random_single_part_sync --features nightly
</code></pre>
<p>For more details regarding nightly tests see <code>nightly/README.md</code>.</p>
<p>Note that what counts as a slow test isnâ€™t exactly defined as of now.
If it takes just a couple seconds then itâ€™s probably fine.  Anything
slower should probably be classified as an expensive test.  In
particular, if libtest complains the test takes more than 60 seconds
then it definitely is and expensive test.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../architecture/how/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../architecture/how/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
