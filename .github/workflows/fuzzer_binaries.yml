name: Fuzzer Binaries
on:
  push:
    paths:
      - "scripts/build_fuzzers.py"

jobs:
  build_fuzzers:
    runs-on: "ubuntu-latest"

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - id: "auth"
        uses: "google-github-actions/auth@v1"
        with:
          workload_identity_provider: "projects/750982429559/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider"
          service_account: "github-service-account@near-fuzzers.iam.gserviceaccount.com"

      - uses: hecrj/setup-rust-action@v1
        with:
          rust-version: nightly

      - name: Install cargo fuzz subcommand crate
        run: cargo install cargo-fuzz

      - name: "Set up GCP SDK"
        uses: "google-github-actions/setup-gcloud@v1"
        with:
          version: ">= 416.0.0"

      - name: "Check gcloud setup"
        run: gcloud info

      - uses: actions/checkout@master

      - uses: actions/setup-python@v4

      - run: pip install -r scripts/build_fuzzers_requirements.txt

      - run: python scripts/build_fuzzers.py
        env:
          RUSTC_BOOTSTRAP: "1"
