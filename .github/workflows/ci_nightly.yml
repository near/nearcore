name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule:
    - cron: '01 07 * * *'

env:
  CI_HACKS: 1

# BE CAREFUL IF EDITING THIS FILE:
# If you add/remove python tests from here, you should also update `check_pytests.py`â€™s list of GHA_TESTS
# so that it stays in-sync, to make sure no tests are lost.

jobs:
  cargo_nextest:
    name: "Cargo Nextest (${{matrix.name}})"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: MacOS
            id: macos
            os: macos-latest-xlarge
            type: stable
            # TODO: Currently only computing linux coverage, because the MacOS runners
            # have files at a different path and thus comes out duplicated.
            upload_profraws: false
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      # Install all the required tools
      - uses: taiki-e/install-action@9b5b983efc779f85e5e5d11539f005e85ccb27ff
        with:
          tool: just,cargo-nextest,cargo-llvm-cov

      # Run the tests:
      - run: mkdir -p coverage/profraw/{unit,binaries}
      # - Run the unit tests, retrieving the coverage information
      - run: just codecov-ci "nextest-slow ${{ matrix.type }}"
      - run: mv coverage/codecov/{new,unit-${{matrix.id}}}.json
      - run: mv coverage/profraw/{new,unit/${{matrix.id}}}.tar.zst

      # Cleanup the target directory, leaving only stuff interesting to llvm-cov, and tarball it
      - run: just tar-bins-for-coverage-ci
      - run: mv coverage/profraw/binaries/{new,${{matrix.id}}}.tar.zst

      # Upload the coverage
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-codecov-${{ github.sha }}-cargo_nextest-${{ matrix.name }}
          path: coverage/codecov
