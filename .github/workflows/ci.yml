name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  merge_group:

env:
  CI_HACKS: 1

# BE CAREFUL IF EDITING THIS FILE:
# If you add/remove python tests from here, you should also update `check_pytests.py`â€™s list of GHA_TESTS
# so that it stays in-sync, to make sure no tests are lost.

jobs:

  pytest_tests:
    name: "Large pytest Tests"
    runs-on: warp-ubuntu-2204-x64-8x
    steps:
      - uses: actions/checkout@v4
      - uses: WarpBuilds/setup-python@v5
        with:
          python-version: 3.11
          cache: pip
      - uses: taiki-e/install-action@7852930e42e73b6c323ae4435f5135b58754dfdd
        with:
          tool: cargo-llvm-cov
      - run: pip3 install --user -r pytest/requirements.txt
      - run: cargo llvm-cov show-env | grep -v RUSTFLAGS | tr -d "'" >> "$GITHUB_ENV"
      - run: echo "RUSTC_WORKSPACE_WRAPPER=$PWD/scripts/coverage-wrapper-rustc" >> "$GITHUB_ENV"
      - run: echo "CARGO=1" >> "$GITHUB_ENV"
      - run: cargo build --locked --profile dev-release -p neard --bin neard
      - run: echo "CURRENT_NEARD=$PWD/target/dev-release/neard" >> "$GITHUB_ENV"
      - run: echo "NEAR_ROOT=$PWD" >> "$GITHUB_ENV"
      - run: for i in {1..100}; do pushd pytest && python3 tests/sanity/upgradable.py && popd || break; done
